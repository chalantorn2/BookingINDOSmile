<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>INDO Smile Booking Form</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/style.css" />
  </head>

  <body>
    <menu-component></menu-component>

    <div class="container py-5">
      <div class="text-center mb-5">
        <h1 class="mb-3">INDO Smile Booking</h1>
        <p class="lead">กรุณาเลือกฟอร์มที่ต้องการกรอก</p>
        <a href="/frontend/main/view.html" class="gap-2 col-3 mx-auto btn btn-secondary">View Bookings</a>
        <a href="/frontend/order/viewOrder.html" class="gap-2 col-3 mx-auto btn btn-secondary">View Order</a>
        <excel-export class="col-3 btn"></excel-export>
      </div>

      <!-- ฟอร์มข้อมูลกลางที่ใช้ร่วมกัน -->
      <div class="card shadow-sm mb-4">
        <div class="card-header text-center bg-dark text-white">
          <h5 class="mb-0">ข้อมูลหลักของ Booking</h5>
        </div>
        <div class="card-body">
          <form id="mainBookingForm">
            <div class="row g-3">
              <div class="col-md-6">
                <label for="agent" class="form-label">Agent</label>
                <input type="text" class="form-control" id="agent" placeholder="ชื่อ Agent" required />
              </div>
              <div class="col-md-6">
                <label for="firstName" class="form-label">First Name</label>
                <input type="text" class="form-control" id="firstName" placeholder="ชื่อลูกค้า" required />
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-md-6">
                <label for="lastName" class="form-label">Last Name</label>
                <input type="text" class="form-control" id="lastName" placeholder="นามสกุลลูกค้า" required />
              </div>
              <div class="col-md-6">
                <label for="pax" class="form-label">Pax</label>
                <input type="number" class="form-control" id="pax" placeholder="จำนวนคน" required />
              </div>
            </div>
            <!-- ปุ่มเพิ่มฟอร์ม Tour และ Transfer -->
            <div class="d-flex justify-content-center mb-4 mt-4">
              <button type="button" class="btn btn-outline-success me-3" id="addTourForm">Add Tour</button>
              <button type="button" class="btn btn-outline-primary" id="addTransferForm">Add Transfer</button>
            </div>
            <!-- Container สำหรับแสดงฟอร์มที่เพิ่ม -->
            <div class="row d-none" id="additionalForms">
              <!-- ฝั่งซ้าย: Tour Bookings -->
              <div class="col-md-6">
                <h4 class="text-center text-success fw-bold">
                  Tour Bookings <span id="tourCount" class="badge bg-success">0</span>
                </h4>

                <div id="tourForms"></div>
              </div>

              <!-- ฝั่งขวา: Transfer Bookings -->
              <div class="col-md-6">
                <h4 class="text-center text-primary fw-bold">
                  Transfer Bookings <span id="transferCount" class="badge bg-primary">0</span>
                </h4>

                <div id="transferForms"></div>
              </div>
            </div>
            <!-- ปุ่มบันทึกข้อมูล (ซ่อนไว้ตอนเริ่มต้น) -->
            <div class="text-center mt-4">
              <button type="submit" class="btn btn-warning btn-lg d-none" id="submitBookingBtn">บันทึกข้อมูล</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js'
      import { getDatabase, ref, push, set } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js'
      import { generateBookingID } from '/js/id.js'
      import { database } from '/js/firebase-config.js'

      document.addEventListener('DOMContentLoaded', function () {
        console.log('DOM Loaded Successfully')

        const addTourBtn = document.getElementById('addTourForm')
        const addTransferBtn = document.getElementById('addTransferForm')
        const additionalForms = document.getElementById('additionalForms')
        const mainForm = document.getElementById('mainBookingForm')
        const tourFormsContainer = document.getElementById('tourForms')
        const transferFormsContainer = document.getElementById('transferForms')
        function getNextAvailableID(type) {
          const existingIDs = [...document.querySelectorAll(`.${type}-form`)]
            .map(el => parseInt(el.id.split('-')[1]))
            .sort((a, b) => a - b)

          let nextID = 1
          while (existingIDs.includes(nextID)) {
            nextID++
          }
          return nextID
        }

        // ฟังก์ชันสร้างฟอร์ม Tour (ใช้ ID ที่เล็กที่สุดที่ยังไม่มีอยู่)
        function createTourForm() {
          const id = getNextAvailableID('tour')
          return `
      <div class="card shadow-sm mt-3 tour-form" id="tour-${id}">
        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Tour Booking #${id}</h6>
          <button type="button" class="btn btn-danger btn-sm remove-tour" data-id="${id}">ลบ</button>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">ประเภท</label>
              <input type="text" class="form-control" name="tourType">
            </div>
            <div class="col-md-6">
              <label class="form-label">ส่งใคร</label>
              <input type="text" class="form-control" name="tourSendTo">
            </div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label">รายละเอียด</label>
              <textarea type="text" class="form-control" name="tourDetail"></textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">เวลารับ</label>
              <input type="text" class="form-control" name="tourPickUpTime">
            </div>
            <div class="col-md-4">
              <label class="form-label">วันที่</label>
              <input type="date" class="form-control" name="tourDate" required>
            </div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label">โรงแรม</label>
              <input type="text" class="form-control" name="tourHotel">
            </div>
            <div class="col-md-4">
              <label class="form-label">หมายเลขห้อง</label>
              <input type="text" class="form-control" name="tourRoomNo">
            </div>
            <div class="col-md-4">
              <label class="form-label">เบอร์ติดต่อ</label>
              <input type="text" class="form-control" name="tourContactNo"> </textarea>
            </div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label">FEE</label>
              <input type="text" class="form-control" name="tourFee">
            </div>
            <div class="col-md-4">
              <label class="form-label">MEAL</label>
              <input type="text" class="form-control" name="tourMeal">
            </div>
            <div class="col-md-4">
              <label class="form-label">หมายเหตุ</label>
              <input type="text" class="form-control" name="tourNote">
            </div>
          </div>
        </div>
      </div>
    `
        }

        // ฟังก์ชันสร้างฟอร์ม Transfer (ใช้ ID ที่เล็กที่สุดที่ยังไม่มีอยู่)
        function createTransferForm() {
          const id = getNextAvailableID('transfer')
          return `
      <div class="card shadow-sm mt-3 transfer-form" id="transfer-${id}">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
          <h6 class="mb-0">Transfer Booking #${id}</h6>
          <button type="button" class="btn btn-danger btn-sm remove-transfer" data-id="${id}">ลบ</button>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">ประเภท</label>
              <input type="text" class="form-control" name="transferType">
            </div>
            <div class="col-md-6">
              <label class="form-label">ส่งใคร</label>
              <input type="text" class="form-control" name="transferSendTo">
            </div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label">รายละเอียด</label>
              <textarea class="form-control" name="transferDetail"> </textarea>
            </div>
            <div class="col-md-4">
              <label class="form-label">เวลารับ</label>
              <input type="text" class="form-control" name="transferPickUpTime">
            </div>
            <div class="col-md-4">
              <label class="form-label">วันที่</label>
              <input type="date" class="form-control" name="transferDate" required>
            </div>
          </div>
          <div class="row g-2 mt-1">
            <div class="col-md-6">
              <label class="form-label">เที่ยวบิน</label>
              <input type="text" class="form-control" name="transferFlight">
            </div>
            <div class="col-md-6">
              <label class="form-label">เวลาบิน</label>
              <input type="text" class="form-control" name="transferTime">
            </div>
          </div>
          <div class="row g-3 mt-1">
            <div class="col-md-4">
              <label class="form-label">รับจาก</label>
              <input type="text" class="form-control" name="transferPickupFrom">
            </div>
            <div class="col-md-4">
              <label class="form-label">ไปส่งที่</label>
              <input type="text" class="form-control" name="transferDropTo">
            </div>
            <div class="col-md-4">
              <label class="form-label">หมายเหตุ</label>
              <input type="text" class="form-control" name="transferNote">
            </div>
          </div>
        </div>
      </div>
    `
        }
        function updateFormCount() {
          const tourForms = document.querySelectorAll('.tour-form').length
          const transferForms = document.querySelectorAll('.transfer-form').length

          document.getElementById('tourCount').textContent = tourForms
          document.getElementById('transferCount').textContent = transferForms
        }
        let tourCounter = 1
        let transferCounter = 1

        const submitBookingBtn = document.getElementById('submitBookingBtn')

        function updateSubmitButtonVisibility() {
          const tourForms = document.querySelectorAll('.tour-form').length
          const transferForms = document.querySelectorAll('.transfer-form').length

          if (tourForms > 0 || transferForms > 0) {
            submitBookingBtn.classList.remove('d-none') // แสดงปุ่ม
            additionalForms.classList.remove('d-none')
          } else {
            submitBookingBtn.classList.add('d-none') // ซ่อนปุ่ม
            additionalForms.classList.add('d-none')
          }
        }

        addTourBtn.addEventListener('click', () => {
          tourFormsContainer.insertAdjacentHTML('beforeend', createTourForm())
          updateSubmitButtonVisibility()
          updateFormCount()
        })

        addTransferBtn.addEventListener('click', () => {
          transferFormsContainer.insertAdjacentHTML('beforeend', createTransferForm())
          updateSubmitButtonVisibility()
          updateFormCount()
        })

        document.getElementById('additionalForms').addEventListener('click', event => {
          if (event.target.classList.contains('remove-tour')) {
            document.getElementById(`tour-${event.target.dataset.id}`).remove()
          }
          if (event.target.classList.contains('remove-transfer')) {
            document.getElementById(`transfer-${event.target.dataset.id}`).remove()
          }
          updateSubmitButtonVisibility()
          updateFormCount()
        })

        document.getElementById('mainBookingForm').addEventListener('submit', async function (e) {
          e.preventDefault()

          try {
            const agent = document.getElementById('agent').value
            const firstName = document.getElementById('firstName').value
            const lastName = document.getElementById('lastName').value
            const pax = document.getElementById('pax').value
            const timestamp = Date.now()
            const status = 'รอดำเนินการ'

            let tourCount = 0
            let tourIDs = []
            let transferCount = 0
            let transferIDs = []

            // ดึงค่าฟอร์ม Tour ที่ถูกเพิ่มเข้ามาทั้งหมด
            const tourForms = document.querySelectorAll('.tour-form')
            for (const tourForm of tourForms) {
              const bookingID = await generateBookingID('tour')

              const formData = {
                tourID: bookingID,
                tourAgent: agent,
                tourFirstName: firstName,
                tourLastName: lastName,
                tourPax: pax,
                tourType: tourForm.querySelector('[name="tourType"]').value,
                tourSendTo: tourForm.querySelector('[name="tourSendTo"]').value,
                tourDetail: tourForm.querySelector('[name="tourDetail"]').value,
                tourPickUpTime: tourForm.querySelector('[name="tourPickUpTime"]').value,
                tourDate: tourForm.querySelector('[name="tourDate"]').value,
                tourHotel: tourForm.querySelector('[name="tourHotel"]').value,
                tourRoomNo: tourForm.querySelector('[name="tourRoomNo"]').value,
                tourContactNo: tourForm.querySelector('[name="tourContactNo"]').value,
                tourFee: tourForm.querySelector('[name="tourFee"]').value,
                tourMeal: tourForm.querySelector('[name="tourMeal"]').value,
                tourNote: tourForm.querySelector('[name="tourNote"]').value,
                status: status,
                timestamp: timestamp,
              }

              const tourRef = ref(database, 'tourBookings')
              const newTourRef = push(tourRef)
              await set(newTourRef, formData)

              tourIDs.push(bookingID)
              tourCount++
            }

            // ดึงค่าฟอร์ม Transfer ที่ถูกเพิ่มเข้ามาทั้งหมด
            const transferForms = document.querySelectorAll('.transfer-form')
            for (const transferForm of transferForms) {
              const bookingID = await generateBookingID('transfer')

              const formData = {
                transferID: bookingID,
                transferAgent: agent,
                transferFirstName: firstName,
                transferLastName: lastName,
                transferPax: pax,
                transferType: transferForm.querySelector('[name="transferType"]').value,
                transferSendTo: transferForm.querySelector('[name="transferSendTo"]').value,
                transferDetail: transferForm.querySelector('[name="transferDetail"]').value,
                transferPickUpTime: transferForm.querySelector('[name="transferPickUpTime"]').value,
                transferDate: transferForm.querySelector('[name="transferDate"]').value,
                transferFlight: transferForm.querySelector('[name="transferFlight"]').value,
                transferTime: transferForm.querySelector('[name="transferTime"]').value,
                transferPickupFrom: transferForm.querySelector('[name="transferPickupFrom"]').value,
                transferDropTo: transferForm.querySelector('[name="transferDropTo"]').value,
                transferNote: transferForm.querySelector('[name="transferNote"]').value,
                status: status,
                timestamp: timestamp,
              }

              const transferRef = ref(database, 'transferBookings')
              const newTransferRef = push(transferRef)
              await set(newTransferRef, formData)

              transferIDs.push(bookingID)
              transferCount++
            }

            // ✅ สร้างข้อความ Alert
            let message = 'บันทึกข้อมูลสำเร็จ!\n\n'
            if (tourCount > 0) {
              message += `✅ Tour Bookings: ${tourCount} รายการ\nID: ${tourIDs.join(', ')}\n\n`
            }
            if (transferCount > 0) {
              message += `✅ Transfer Bookings: ${transferCount} รายการ\nID: ${transferIDs.join(', ')}\n\n`
            }

            alert(message)

            // ✅ รีเซ็ตฟอร์ม
            document.getElementById('mainBookingForm').reset()
            additionalForms.innerHTML = '' // ล้างฟอร์ม Tour & Transfer ที่ถูกเพิ่มเข้ามา
            updateSubmitButtonVisibility() // ซ่อนปุ่มบันทึกถ้าไม่มี Booking
          } catch (error) {
            console.error('Error in form submission:', error)
            alert('เกิดข้อผิดพลาดในการบันทึกข้อมูล')
          }
        })
      })
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="/component/menu.js"></script>
    <script type="module" src="/js/id.js"></script>
    <script type="module" src="/component/excel_export.js"></script>
  </body>
</html>
