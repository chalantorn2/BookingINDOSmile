<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Payments</title>
    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Select (สำหรับ Search+Dropdown) -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/css/bootstrap-select.min.css"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/order.css" />
  </head>

  <body>
    <menu-component></menu-component>

    <div class="container py-5">
      <div class="header text-center mb-4">
        <h1 class="title">Payments</h1>
        <p class="subtitle">จัดการการคิดเงินสำหรับ Orders</p>
      </div>

      <!-- Orders List -->
      <div class="mt-4 text-center">
        <h2 class="mb-3">Orders</h2>
        <div class="row justify-content-center">
          <!-- ที่ส่วนการเลือก Order -->
          <div class="col-md-6 d-flex align-items-center">
            <select class="form-select w-100" id="orderDropdown">
              <option value="">Loading...</option>
            </select>
            <!-- ปุ่มไปหน้า Invoice -->
            <button class="btn btn-secondary ms-2" id="goToInvoiceBtn">
              <i class="bi bi-file-earmark-text"></i> ไปหน้า Invoice
            </button>
          </div>
        </div>
      </div>

      <!-- Booking Container -->
      <div class="mt-5 d-none" id="bookingContainer">
        <!-- แสดงชื่อ-นามสกุล และจำนวนคน (แค่ครั้งเดียว) -->
        <div class="text-center mb-4">
          <!-- <h2>Booking Details</h2> -->
          <p
            id="customerNameDisplay"
            class="fs-2 fw-bold text-primary mt-3"
          ></p>
        </div>

        <!-- 1) แสดงรายการ Booking ให้กดเลือก -->
        <div class="row" id="bookingList"></div>

        <!-- 2) ตารางแสดง Booking ที่ถูก Add -->
        <div class="mt-5 d-none" id="selectedBookingsContainer">
          <h3 class="text-center mb-3">Selected Bookings</h3>
          <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
              <thead class="table-info">
                <tr>
                  <th>ID</th>
                  <th>Send To</th>
                  <th>Date</th>
                  <!-- เพิ่ม -->
                  <th>Hotel</th>
                  <!-- เพิ่ม -->
                  <th>Details</th>
                  <!-- เดิมเป็นข้อความ เปลี่ยนเป็น input -->
                  <th>Type</th>
                  <th>Cost</th>
                  <th>Pax</th>
                  <th>Total Cost</th>
                  <th>Selling Price</th>
                  <th>Profit</th>
                  <th>Remove</th>
                </tr>
              </thead>

              <tbody id="bookingDetailsTable">
                <tr>
                  <td colspan="10" class="text-center">
                    ยังไม่มีการเลือก Booking
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Summary Section -->
        <div class="mt-4 d-none" id="summaryContainer">
          <!-- ปรับดีไซน์ Summary ให้อยู่ใน card -->
          <div class="card shadow-sm">
            <div class="card-body">
              <!-- <h3 class="text-center mb-3">Summary</h3> -->
              <div class="row text-center">
                <div class="col-md-4 mb-3">
                  <p>
                    <strong>รวมต้นทุนทั้งหมด:</strong><br />
                    <span class="fs-2 fw-bold text-info" id="totalCost">0</span>
                  </p>
                </div>
                <div class="col-md-4 mb-3">
                  <p>
                    <strong>รวมราคาขายทั้งหมด:</strong><br />
                    <span
                      class="fs-2 fw-bold text-primary"
                      id="totalSellingPrice"
                      >0</span
                    >
                  </p>
                </div>
                <div class="col-md-4 mb-3">
                  <p>
                    <strong>กำไรรวมทั้งหมด:</strong><br />
                    <span class="fs-2 fw-bold text-success" id="totalProfit"
                      >0</span
                    >
                  </p>
                </div>
              </div>
              <!-- ปุ่ม Save -->
              <div class="text-center">
                <button class="btn btn-success px-4" id="saveDataBtn">
                  <i class="bi bi-save"></i> บันทึกข้อมูล
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <!-- jQuery (ต้องมาก่อน bootstrap-select) -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Bootstrap Select JS (สำหรับทำ Live Search ใน Dropdown) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.14.0-beta3/dist/js/bootstrap-select.min.js"></script>
    <script type="module" src="/component/menu.js"></script>
    <!-- Firebase และโค้ดหลัก -->
    <script type="module">
      import { database } from "/js/firebase-config.js";
      import {
        ref,
        get,
        set,
      } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";
      let globalFirstName = "";
      let globalLastName = "";
      let globalPax = 0;
      // ฟังก์ชันช่วย: ตัดทศนิยมทั้งหมด + ใส่เครื่องหมาย , คั่นหลักพัน
      function formatNumberWithCommas(num) {
        const intNum = Math.floor(num); // ปัดทศนิยมทิ้ง
        return intNum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
      }

      document.addEventListener("DOMContentLoaded", async () => {
        const orderDropdown = document.getElementById("orderDropdown");
        const bookingContainer = document.getElementById("bookingContainer");
        const customerNameDisplay = document.getElementById(
          "customerNameDisplay"
        );
        const bookingList = document.getElementById("bookingList");
        const selectedBookingsContainer = document.getElementById(
          "selectedBookingsContainer"
        );
        const bookingDetailsTable = document.getElementById(
          "bookingDetailsTable"
        );
        const summaryContainer = document.getElementById("summaryContainer");
        const totalCost = document.getElementById("totalCost");
        const totalSellingPrice = document.getElementById("totalSellingPrice");
        const totalProfit = document.getElementById("totalProfit");
        const saveDataBtn = document.getElementById("saveDataBtn");

        if (
          !orderDropdown ||
          !bookingContainer ||
          !customerNameDisplay ||
          !bookingList ||
          !selectedBookingsContainer ||
          !bookingDetailsTable ||
          !summaryContainer ||
          !totalCost ||
          !totalSellingPrice ||
          !totalProfit ||
          !saveDataBtn
        ) {
          console.error("Some elements are missing in the DOM");
          return;
        }

        // โหลด Orders จาก Firebase
        const ordersRef = ref(database, "orders");
        const ordersSnapshot = await get(ordersRef);

        if (!ordersSnapshot.exists()) {
          orderDropdown.innerHTML = '<option value="">No orders found</option>';
          return;
        }

        const orders = ordersSnapshot.val();
        orderDropdown.innerHTML = "<option value=''>Select an Order</option>";

        Object.keys(orders).forEach((firebaseId) => {
          const order = orders[firebaseId];
          const orderId = order.id || firebaseId;
          const option = document.createElement("option");
          option.value = firebaseId; // เก็บ key จาก Firebase
          option.textContent = orderId; // โชว์เป็น orderId
          orderDropdown.appendChild(option);
        });

        // เปิดใช้งาน selectpicker (live search)
        orderDropdown.classList.add("selectpicker");
        orderDropdown.setAttribute("data-live-search", "true");
        window.$(orderDropdown).selectpicker();

        // เมื่อมีการเปลี่ยน Order
        orderDropdown.addEventListener("change", async () => {
          const selectedOrderKey = orderDropdown.value;
          if (selectedOrderKey) {
            bookingContainer.classList.remove("d-none");
            await loadBookings(selectedOrderKey);
          } else {
            // ถ้าไม่เลือก
            bookingContainer.classList.add("d-none");
            customerNameDisplay.textContent = "";
            bookingList.innerHTML = "";
            bookingDetailsTable.innerHTML = `
              <tr>
                <td colspan="10" class="text-center">ยังไม่มีการเลือก Booking</td>
              </tr>
            `;
            selectedBookingsContainer.classList.add("d-none");
            summaryContainer.classList.add("d-none");
          }
        });

        // ฟังก์ชันคำนวณสรุป
        function updateSummary() {
          let sumTotalCost = 0;
          let sumSellingPrice = 0;
          let sumProfit = 0;

          const rows = bookingDetailsTable.querySelectorAll("tr");
          rows.forEach((row) => {
            const totalCostCell = row.querySelector(".totalCostCell");
            const profitCell = row.querySelector(".profitCell");
            const sellingPriceInput = row.querySelector(".sellingPriceInput");

            if (totalCostCell && profitCell && sellingPriceInput) {
              const costValRaw = totalCostCell.textContent.replace(/,/g, "");
              const profitValRaw = profitCell.textContent.replace(/,/g, "");
              const sellingPriceVal =
                parseFloat(sellingPriceInput.value.replace(/,/g, "")) || 0;

              const costVal = parseFloat(costValRaw) || 0;
              const profitVal = parseFloat(profitValRaw) || 0;

              sumTotalCost += costVal;
              sumSellingPrice += sellingPriceVal;
              sumProfit += profitVal;
            }
          });

          // ใส่สัญลักษณ์ ฿ และ format commas
          totalCost.textContent = "฿" + formatNumberWithCommas(sumTotalCost);
          totalSellingPrice.textContent =
            "฿" + formatNumberWithCommas(sumSellingPrice);
          totalProfit.textContent = "฿" + formatNumberWithCommas(sumProfit);
        }

        // ฟังก์ชันแปลง "YYYY-MM-DD" => "DD/MM/YYYY"
        function formatToDDMMYYYY(isoStr) {
          if (!isoStr) return "";
          const parts = isoStr.split("-"); // สมมติว่าเก็บเป็น YYYY-MM-DD
          if (parts.length !== 3) return isoStr;
          const [y, m, d] = parts;
          return `${d}/${m}/${y}`; // "DD/MM/YYYY"
        }

        // ฟังก์ชันสร้าง <tr> ในตาราง
        function createBookingRow(booking, countSpan) {
          const isTour = booking.type === "tour";

          // 1) เอา Date จาก booking (tourDate / transferDate)
          const dateRaw = isTour ? booking.tourDate : booking.transferDate;
          // format => dd/mm/yyyy (read-only)
          const displayDate = formatToDDMMYYYY(dateRaw || "");

          // 2) Hotel => เป็น input
          const hotelVal = isTour
            ? booking.tourHotel || ""
            : booking.transferHotel || "";

          // 3) Details => เป็น <textarea> (หรือ input)
          const detailVal = isTour
            ? booking.tourDetail || ""
            : booking.transferDetail || "";

          // ฟิลด์อื่น ๆ
          const id = isTour ? booking.tourID : booking.transferID;
          const sendTo = isTour ? booking.tourSendTo : booking.transferSendTo;
          const bookingType = booking.bookingType || "";
          let cost = Math.floor(parseFloat(booking.cost) || 0);
          let quantity = Math.floor(parseFloat(booking.quantity) || 0);
          let sellingPrice = Math.floor(parseFloat(booking.sellingPrice) || 0);

          const totalCostVal = cost * quantity;
          const profitVal = sellingPrice - totalCostVal;

          // สร้าง <tr> (ปรับ thead ให้มี 12 column ตามลำดับ: ID, SendTo, Date, Hotel, Details, Type, Cost, Pax, TotalCost, SellingPrice, Profit, Remove)
          const row = document.createElement("tr");
          row.dataset.type = booking.type;
          row.dataset.chosenCount = 1; // เพื่อจัดการ chosenCount

          row.innerHTML = `
    <td>${id || "-"}</td>
    <td>${sendTo || "-"}</td>
    
    <!-- Date => read only (DD/MM/YYYY) -->
    <td class="dateCell">${displayDate}</td>
    
    <!-- Hotel => <input> -->
    <td>
      <input
        type="text"
        class="hotelInput form-control"
        style="min-width: 150px; white-space: pre-wrap;"
        value="${hotelVal}"
      />
    </td>
    
    <!-- Details => <textarea> -->
    <td>
      <textarea
        class="detailInput form-control"
        rows="2"
        style="min-width: 150px; white-space: pre-wrap;"
      >${detailVal}</textarea>
    </td>
    
    <td>
      <select class="bookingType form-select">
        <option value="" ${
          bookingType === "" ? "selected" : ""
        }>--Select--</option>
        <option value="ADL" ${
          bookingType === "ADL" ? "selected" : ""
        }>ADL</option>
        <option value="CHD" ${
          bookingType === "CHD" ? "selected" : ""
        }>CHD</option>
      </select>
    </td>
    
    <td>
      <input
        type="number"
        step="any"
        class="costInput form-control"
        value="${cost}"
      />
    </td>
    <td>
      <input
        type="number"
        class="quantityInput form-control"
        value="${quantity}"
      />
    </td>
    <td class="totalCostCell">${totalCostVal.toLocaleString()}</td>
    
    <td>
      <input
        type="number"
        step="any"
        class="sellingPriceInput form-control"
        value="${sellingPrice}"
      />
    </td>
    <td class="profitCell">${profitVal.toLocaleString()}</td>
    
    <td>
      <button class="btn btn-danger btnRemoveBooking">
        <i class="bi bi-trash"></i>
      </button>
    </td>
  `;

          // ผูก event update cost/quantity/sellingPrice
          const costInput = row.querySelector(".costInput");
          const quantityInput = row.querySelector(".quantityInput");
          const sellingPriceInput = row.querySelector(".sellingPriceInput");
          const totalCostCell = row.querySelector(".totalCostCell");
          const profitCell = row.querySelector(".profitCell");
          const bookingTypeSelect = row.querySelector(".bookingType");
          const removeBtn = row.querySelector(".btnRemoveBooking");

          function updateRow() {
            let newCost = Math.floor(parseFloat(costInput.value) || 0);
            let newQuantity = Math.floor(parseFloat(quantityInput.value) || 0);
            let newSellingPrice = Math.floor(
              parseFloat(sellingPriceInput.value) || 0
            );

            costInput.value = newCost;
            quantityInput.value = newQuantity;
            sellingPriceInput.value = newSellingPrice;

            const newTotalCost = newCost * newQuantity;
            const newProfit = newSellingPrice - newTotalCost;

            totalCostCell.textContent = newTotalCost.toLocaleString();
            profitCell.textContent = newProfit.toLocaleString();

            updateSummary();
          }

          costInput.addEventListener("input", updateRow);
          quantityInput.addEventListener("input", updateRow);
          sellingPriceInput.addEventListener("input", updateRow);
          bookingTypeSelect.addEventListener("change", updateSummary);

          removeBtn.addEventListener("click", () => {
            row.remove();
            if (
              typeof booking._chosenCount === "number" &&
              booking._chosenCount > 0
            ) {
              booking._chosenCount--;
              updateChosenCountUI(booking, countSpan);
            }
            // ถ้าไม่มีแถว => placeholder
            const rowsLeft = bookingDetailsTable.querySelectorAll("tr");
            if (rowsLeft.length === 0) {
              bookingDetailsTable.innerHTML = `
        <tr>
          <td colspan="12" class="text-center">ยังไม่มีการเลือก Booking</td>
        </tr>
      `;
              summaryContainer.classList.add("d-none");
            }
            updateSummary();
          });

          return row;
        }
        // ฟังก์ชันอัปเดต chosenCount UI บนการ์ด
        function updateChosenCountUI(booking, countSpan) {
          if (!countSpan) return;
          countSpan.textContent = booking._chosenCount;
          if (booking._chosenCount >= 1) {
            countSpan.classList.remove("bg-secondary");
            countSpan.classList.add("bg-primary");
          } else {
            countSpan.classList.remove("bg-primary");
            countSpan.classList.add("bg-secondary");
          }
        }

        // ฟังก์ชัน: เมื่อคลิกปุ่ม Add Booking
        function addBookingToTable(booking, countSpan) {
          // ถ้ามี placeholder => ลบออก
          if (bookingDetailsTable.querySelector("td[colspan='10']")) {
            bookingDetailsTable.innerHTML = "";
          }

          // สร้างแถว
          const newRow = createBookingRow(booking, countSpan);
          bookingDetailsTable.appendChild(newRow);

          // นับ chosenCount
          booking._chosenCount = (booking._chosenCount || 0) + 1;
          updateChosenCountUI(booking, countSpan);

          selectedBookingsContainer.classList.remove("d-none");
          summaryContainer.classList.remove("d-none");
          updateSummary();
        }

        // ---------------------------------------
        // ฟังก์ชันโหลด Booking ตาม Order Key
        // (พร้อมโหลดข้อมูล Payment ที่ "payments/P_${orderID}")
        // ---------------------------------------
        async function loadBookings(orderKey) {
          // 1) ดึง orderObj + orderId
          const orderObj = orders[orderKey];
          const orderId = orderObj.id || orderKey;

          // 2) สร้าง paymentKey = "P_"+orderId
          const paymentKey = "P_" + orderId;

          // 3) เตรียม ref สำหรับ Booking + Payment
          const tourBookingsRef = ref(database, "tourBookings");
          const transferBookingsRef = ref(database, "transferBookings");
          const paymentDataRef = ref(database, "payments/" + paymentKey);

          // 4) get data
          const [tourSnapshot, transferSnapshot, paymentSnapshot] =
            await Promise.all([
              get(tourBookingsRef),
              get(transferBookingsRef),
              get(paymentDataRef),
            ]);

          // Clear ตาราง
          bookingList.innerHTML = "";
          bookingDetailsTable.innerHTML = `
            <tr>
              <td colspan="10" class="text-center">ยังไม่มีการเลือก Booking</td>
            </tr>
          `;
          selectedBookingsContainer.classList.add("d-none");
          summaryContainer.classList.add("d-none");
          totalCost.textContent = "฿0";
          totalSellingPrice.textContent = "฿0";
          totalProfit.textContent = "฿0";

          let allBookings = [];

          // รวม Tour + Transfer ที่มี orderId ตรงกัน
          if (tourSnapshot.exists()) {
            Object.values(tourSnapshot.val()).forEach((b) => {
              if (b.orderId === orderId) {
                allBookings.push({ type: "tour", ...b });
              }
            });
          }
          if (transferSnapshot.exists()) {
            Object.values(transferSnapshot.val()).forEach((b) => {
              if (b.orderId === orderId) {
                allBookings.push({ type: "transfer", ...b });
              }
            });
          }

          // แสดงชื่อ-นามสกุล และ pax
          if (allBookings.length > 0) {
            const firstBooking = allBookings[0];
            const isTour = firstBooking.type === "tour";
            globalFirstName = isTour
              ? firstBooking.tourFirstName
              : firstBooking.transferFirstName;
            globalLastName = isTour
              ? firstBooking.tourLastName
              : firstBooking.transferLastName;
            globalPax = isTour
              ? firstBooking.tourPax
              : firstBooking.transferPax;

            // แล้วเอาไปแสดงบน customerNameDisplay
            customerNameDisplay.textContent = `${globalFirstName} ${globalLastName} / ${globalPax} คน`;
          } else {
            globalFirstName = "";
            globalLastName = "";
            globalPax = 0;
            customerNameDisplay.textContent = "No customer info.";
          }

          // สร้างรายการ booking ให้ผู้ใช้เลือก Add
          allBookings.forEach((booking, index) => {
            booking._chosenCount = 0; // initialize
            const isTour = booking.type === "tour";
            const bookingId = isTour ? booking.tourID : booking.transferID;
            const cardHeader = isTour
              ? booking.tourSendTo
              : booking.transferSendTo;
            const cardDetail = isTour
              ? booking.tourDetail
              : booking.transferDetail;

            const colDiv = document.createElement("div");
            colDiv.classList.add("col-md-4", "mb-3");

            colDiv.innerHTML = `
              <div class="card h-100 shadow-sm" data-type="${
                booking.type || ""
              }" data-id="${bookingId}">
                <div class="card-body">
                  <h5 class="card-title fw-bold text-truncate">${
                    cardHeader || "-"
                  }</h5>
                  <p class="card-text fst-italic lh-1 ">
                    ${cardDetail || ""}
                  </p>
                  <strong>Booking #${index + 1}:</strong> ${
              isTour ? "Tour" : "Transfer"
            }<br/>
                  ...
                  <div class="d-flex justify-content-between align-items-center mt-3">
                    <button class="btn btn-primary btnAddBooking" type="button">
                      <i class="bi bi-plus-lg"></i> Add
                    </button>
                    <span>
                      <small>Chosen: </small>
                      <span class="chosenCount badge bg-secondary">0</span>
                      <small> times</small>
                    </span>
                  </div>
                </div>
              </div>
            `;

            const btnAddBooking = colDiv.querySelector(".btnAddBooking");
            const chosenCountSpan = colDiv.querySelector(".chosenCount");

            btnAddBooking.addEventListener("click", () => {
              addBookingToTable(booking, chosenCountSpan);
            });

            bookingList.appendChild(colDiv);
          });

          // -------------------------------------------------------
          // ถ้ามีการเซฟข้อมูลใน payments/P_{orderId} => โหลดมาโชว์
          // -------------------------------------------------------
          if (paymentSnapshot.exists()) {
            const savedData = paymentSnapshot.val();
            const savedBookings = savedData.bookings || [];

            if (Array.isArray(savedBookings)) {
              bookingDetailsTable.innerHTML = "";
              selectedBookingsContainer.classList.remove("d-none");
              summaryContainer.classList.remove("d-none");

              // รวม count สำหรับอัปเดต UI ในการ์ด
              const chosenCountMap = {};

              // 1) loop สร้างแถวในตาราง
              savedBookings.forEach((item) => {
                const dummyBooking = {
                  type: item.type || "",
                  tourID: item.id,
                  transferID: item.id,

                  // ดึง tourDate / transferDate / hotel
                  tourDate: item.tourDate || "",
                  transferDate: item.transferDate || "",
                  tourHotel: item.tourHotel || "",
                  transferHotel: item.transferHotel || "",

                  tourSendTo: item.sendTo,
                  transferSendTo: item.sendTo,
                  tourDetail: item.detail,
                  transferDetail: item.detail,
                  cost: item.cost,
                  quantity: item.quantity,
                  sellingPrice: item.sellingPrice,
                  bookingType: item.bookingType || "",
                  _chosenCount: item.chosenCount || 0,
                };

                // key = type|id
                const key = `${item.type || ""}|${item.id || ""}`;
                if (!chosenCountMap[key]) chosenCountMap[key] = 0;
                chosenCountMap[key] += item.chosenCount || 0;

                // สร้าง chosenSpan
                const chosenSpan = document.createElement("span");
                chosenSpan.classList.add("chosenCount", "badge");

                const row = createBookingRow(dummyBooking, chosenSpan);
                bookingDetailsTable.appendChild(row);
              });

              // 2) อัปเดต chosenCount บนการ์ด
              bookingList.querySelectorAll(".card").forEach((cardEl) => {
                const cardType = cardEl.dataset.type || "";
                const cardId = cardEl.dataset.id || "";
                const chosenSpan = cardEl.querySelector(".chosenCount");
                if (!chosenSpan) return;

                const key = `${cardType}|${cardId}`;
                const totalChosen = chosenCountMap[key] || 0;

                chosenSpan.textContent = totalChosen;
                if (totalChosen >= 1) {
                  chosenSpan.classList.remove("bg-secondary");
                  chosenSpan.classList.add("bg-primary");
                } else {
                  chosenSpan.classList.remove("bg-primary");
                  chosenSpan.classList.add("bg-secondary");
                }
              });

              updateSummary();
            }
          }
        }

        // ----------------------------
        // ฟังก์ชันสร้าง Payment ID
        // ----------------------------
        function generatePaymentID(orderID) {
          return `P_${orderID}`;
        }

        // เมื่อกดปุ่มบันทึกข้อมูล
        // ฟังก์ชันแปลง "DD/MM/YYYY" => "YYYY-MM-DD"
        function parseDDMMYYYY(ddmmyyyy) {
          if (!ddmmyyyy) return "";
          const parts = ddmmyyyy.split("/");
          if (parts.length !== 3) return ddmmyyyy;
          const [d, m, y] = parts; // "12", "01", "2025"
          return `${y}-${m}-${d}`; // "2025-01-12"
        }

        // สมมติว่าคุณประกาศตัวแปร global ไว้บนสุดไฟล์ หรือถ้าเป็น Block ขอบเขตเดียวกันก็ได้
        // let globalFirstName = "";
        // let globalLastName = "";
        // let globalPax = 0;

        // ------- ฟังก์ชันกดปุ่ม Save -------
        saveDataBtn.addEventListener("click", async () => {
          const selectedOrderKey = orderDropdown.value;
          if (!selectedOrderKey) {
            alert("กรุณาเลือก Order ก่อน");
            return;
          }

          // โหลดข้อมูล order เพื่อเอา orderID
          const orderRef = ref(database, `orders/${selectedOrderKey}`);
          const orderSnapshot = await get(orderRef);

          if (!orderSnapshot.exists()) {
            alert("ไม่พบข้อมูล Order");
            return;
          }

          const orderData = orderSnapshot.val();
          const orderID = orderData.id;
          if (!orderID) {
            alert("ไม่พบ Order ID ในข้อมูล Order");
            return;
          }

          // ตรวจสอบว่ามี booking บนตารางหรือไม่
          const rows = bookingDetailsTable.querySelectorAll("tr");
          if (rows.length === 1 && rows[0].querySelector("td[colspan='12']")) {
            alert("ไม่มีข้อมูล Booking ในตาราง");
            return;
          }

          // -------------------------------------------------
          // สร้างอาร์เรย์ bookings จากข้อมูลในตาราง
          // -------------------------------------------------
          const bookingsArray = [];

          rows.forEach((row) => {
            const removeBtn = row.querySelector(".btnRemoveBooking");
            if (!removeBtn) return; // ข้าม placeholder

            // 1) ดึงค่า type, chosenCount จาก row.dataset
            const rowType = row.dataset.type || "";
            const rowChosenCount = parseInt(row.dataset.chosenCount, 10) || 1;

            // 2) ดึง element inputs เช่น .hotelInput, .detailInput ฯลฯ
            const hotelInput = row.querySelector(".hotelInput");
            const detailInput = row.querySelector(".detailInput");
            const bookingTypeSelect = row.querySelector(".bookingType");
            const costInput = row.querySelector(".costInput");
            const quantityInput = row.querySelector(".quantityInput");
            const sellingPriceInput = row.querySelector(".sellingPriceInput");

            // 3) ดึง ID, SendTo จาก td
            const cells = row.querySelectorAll("td");
            const idText = cells[0].textContent.trim();
            const sendToText = cells[1].textContent.trim();

            // 4) อ่านค่า Date (read-only) จาก td (index 2) แล้ว parse
            // สมมติ index 2 คือ dateCell => DD/MM/YYYY
            const dateCell = cells[2];
            const ddmmStr = dateCell ? dateCell.textContent.trim() : "";
            const isoDate = parseDDMMYYYY(ddmmStr); // "YYYY-MM-DD"

            // 5) แปลงค่าจาก input
            const hotelVal = hotelInput ? hotelInput.value.trim() : "";
            const detailVal = detailInput ? detailInput.value.trim() : "";
            const bType = bookingTypeSelect.value;
            const costVal = Math.floor(parseFloat(costInput.value) || 0);
            const quantityVal = Math.floor(
              parseFloat(quantityInput.value) || 0
            );
            const sellingPriceVal = Math.floor(
              parseFloat(sellingPriceInput.value) || 0
            );

            // 6) สร้าง bookingObj
            let bookingObj = {
              type: rowType,
              id: idText,
              sendTo: sendToText,
              bookingType: bType,
              cost: costVal,
              quantity: quantityVal,
              sellingPrice: sellingPriceVal,
              chosenCount: rowChosenCount,
              detail: detailVal,
            };

            // 7) แยกเก็บ date/hotel ตามประเภท
            if (rowType === "tour") {
              bookingObj.tourDate = isoDate;
              bookingObj.tourHotel = hotelVal;
            } else if (rowType === "transfer") {
              bookingObj.transferDate = isoDate;
              bookingObj.transferHotel = hotelVal; // ถ้าคุณไม่ต้องการ เก็บก็ลบออก
            }

            bookingsArray.push(bookingObj);
          });

          // -------------------------------------------------
          // อ่านค่าจาก summary
          // -------------------------------------------------
          const totalCostVal =
            parseInt(totalCost.textContent.replace(/[^\d]/g, ""), 10) || 0;
          const totalSellingVal =
            parseInt(totalSellingPrice.textContent.replace(/[^\d]/g, ""), 10) ||
            0;
          const totalProfitVal =
            parseInt(totalProfit.textContent.replace(/[^\d]/g, ""), 10) || 0;

          // -------------------------------------------------
          // เก็บชื่อ-นามสกุล และ pax
          //  (สมมติว่าเรามี globalFirstName, globalLastName, globalPax)
          //  หรือคุณจะ parse จาก textContent ของ customerNameDisplay ก็ได้
          // -------------------------------------------------
          const customerObj = {
            firstName: globalFirstName || "",
            lastName: globalLastName || "",
            pax: globalPax || 0,
          };

          // -------------------------------------------------
          // สร้าง finalData พร้อมเพิ่ม customerObj
          // -------------------------------------------------
          const paymentID = `P_${orderID}`;
          const finalData = {
            paymentID: paymentID,
            orderID: orderID,
            bookings: bookingsArray,
            summary: {
              totalCost: totalCostVal,
              totalSellingPrice: totalSellingVal,
              totalProfit: totalProfitVal,
            },
            customer: customerObj, // <<<< ใส่ในโหนด customer
          };

          // -------------------------------------------------
          // บันทึกลง Firebase
          // -------------------------------------------------
          try {
            await set(ref(database, `payments/${paymentID}`), finalData);
            alert(`บันทึกข้อมูลสำเร็จ! Payment ID: ${paymentID}`);
          } catch (err) {
            console.error("Error saving data: ", err);
            alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล");
          }
        });
      });

      // ปุ่มไปหน้า invoice
      // ...
      const goToInvoiceBtn = document.getElementById("goToInvoiceBtn");

      goToInvoiceBtn.addEventListener("click", () => {
        // ถ้าต้องการส่งพารามิเตอร์ orderKey ไปด้วย ก็ให้ประกอบ Query string
        // หรือถ้าคุณอยากส่งหลาย orderKeys / หลาย paymentIDs ก็ปรับได้
        // ตัวอย่างเรียบง่าย: ไม่ส่งอะไร => เปิด invoice.html เปล่า ๆ
        window.location.href = "/frontend/main/invoice.html";
      });

      // เผื่อมีฟังก์ชัน formatDate ใช้ภายหลัง
      function formatDate(dateStr) {
        if (!dateStr || dateStr === "-") return "-";
        const [year, month, day] = dateStr.split("-");
        if (!year || !month || !day) return dateStr;
        return `${day}/${month}/${year}`;
      }
    </script>
  </body>
</html>
