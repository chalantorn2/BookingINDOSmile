<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>Invoice</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
    <link rel="stylesheet" href="/css/invoice.css" />
  </head>
  <body>
    <menu-component class="no-print"></menu-component>
    <div class="container py-4">
      <div class="no-print text-center mb-3">
        <h2 class="invoice-title">Invoice</h2>
        <p class="text-muted">รายละเอียด Order / Payment ทั้งหมด</p>
      </div>

      <div class="text-center mb-4 no-print">
        <button class="btn btn-warning me-2" id="selectPaymentsBtn">
          <i class="bi bi-check-all"></i> Select Payments
        </button>

        <button class="btn btn-success me-2" id="saveInvoiceBtn"><i class="bi bi-save"></i> บันทึก Invoice</button>
        <button class="btn btn-primary me-2" id="editInvoiceBtn">Edit Invoice</button>

        <!-- <button class="btn btn-primary me-2" id="exportCsvBtn" disabled>
          <i class="bi bi-file-earmark-spreadsheet"></i> Export ข้อมูล
        </button> -->

        <button class="btn btn-info me-2" id="viewInvoiceBtn"><i class="bi bi-eye"></i> View Invoice</button>

        <button class="btn btn-secondary" onclick="window.location.href='/frontend/main/payments.html'">
          <i class="bi bi-arrow-left"></i> กลับไปหน้า Payments
        </button>
      </div>

      <div class="text-center align-middle mb-4">
        <div class="no-print form-check d-inline-block">
          <input class="form-check-input" type="checkbox" id="showCostProfitCheckbox" />
          <label class="form-check-label" for="showCostProfitCheckbox"> แสดงต้นทุน (Cost) และกำไร (Profit) </label>
        </div>
      </div>

      <div class="yes-print row mb-3">
        <div class="col-8 text-start">
          <img id="bannerImage" src="/images/logo-banner.png" alt="Banner" style="max-width: 100%" />
        </div>

        <div class="col-4 text-end fs-6">
          <h1 class="mb-1 fw-bold">INVOICE</h1>
          <div class="mb-1">ATTN : ACCOUNTING DEPT.</div>
          <div class="mb-1">FAX : 038-427-922</div>
          <div>
            DATE:
            <span
              id="invoiceDateSpan"
              class="dateCell fw-semibold fs-5 fst-italic custom-bg text-white rounded-2 px-3"
              data-invoice-key=""
            >
              กรุณากรอกวันที่
            </span>
          </div>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-bordered text-center align-middle" id="invoiceTable">
          <thead class="table-light text-center align-middle">
            <tr>
              <th>Item</th>
              <th>NAME</th>
              <th>REF.</th>
              <th>Hotel</th>
              <th>Date in PHUKET</th>
              <th>TOUR INCLUDE</th>
              <th>PRICE</th>
              <th>Fee</th>
              <th>Unit</th>
              <th>TOTAL</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="row mt-2">
        <div class="col-6 text-start">
          <p class="mb-1 fw-bold">PAYMENT TO INDO SMILE PHUKET</p>
          <p class="mb-1">KRUNGSRI 6641121789</p>
          <p class="mb-1">ACCT : TAWEE WONGPIENKIT</p>
        </div>
      </div>

      <div class="text-end mt-3 fs-5 fw-bold" id="grandTotalDisplay"></div>
    </div>
    <div id="summaryCostProfitContainer" style="display: none">
      <div class="row text-center mt-4">
        <div class="col-md-4 mb-3">
          <p>
            <strong>รวมต้นทุนทั้งหมด:</strong><br />
            <span class="fs-2 fw-bold text-info" id="totalCost">0</span>
          </p>
        </div>
        <div class="col-md-4 mb-3">
          <p>
            <strong>รวมราคาขายทั้งหมด:</strong><br />
            <span class="fs-2 fw-bold text-primary" id="totalSellingPrice">0</span>
          </p>
        </div>
        <div class="col-md-4 mb-3">
          <p>
            <strong>กำไรรวมทั้งหมด:</strong><br />
            <span class="fs-2 fw-bold text-success" id="totalProfit">0</span>
          </p>
        </div>
      </div>
    </div>

    <div
      class="modal fade"
      id="selectPaymentsModal"
      tabindex="-1"
      aria-labelledby="selectPaymentsModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="selectPaymentsModalLabel">เลือก Payments ที่ต้องการสร้าง Invoice</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div id="paymentsListContainer"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" id="confirmSelectBtn">Confirm Selection</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="viewInvoiceModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">View Invoice</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <select class="form-select" id="invoicesSelect"></select>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-primary" id="viewSelectedInvoiceBtn">View</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="editInvoiceModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Edit Invoice</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="invoiceSearchInput" class="form-label">Select Invoice</label>
              <input
                type="text"
                class="form-control"
                id="invoiceSearchInput"
                placeholder="Type to search invoice"
                list="invoicesDataList"
              />
              <datalist id="invoicesDataList"></datalist>
            </div>
            <div class="mb-3">
              <ul class="list-group" id="selectedPaymentsList"></ul>
            </div>
            <div>
              <button class="btn btn-success" id="addPaymentBtn">Add Payment</button>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-primary" id="saveEditInvoiceBtn">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="addPaymentModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Add Payment</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="addPaymentModalBody">
            <ul class="list-group" id="addPaymentList"></ul>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="/component/menu.js"></script>
    <script type="module">
      import { database } from '/js/firebase-config.js'
      import { ref, get, set, push } from 'https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js'

      function formatNumberWithCommas(num) {
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',')
      }

      function parseDateStr(dateStr) {
        if (!dateStr) return null
        const [d, m, y] = dateStr.split('/')
        if (!d || !m || !y) return null
        return new Date(parseInt(y), parseInt(m) - 1, parseInt(d))
      }

      function formatToShortThaiDate(dateObj) {
        if (!dateObj) return '-'
        const day = dateObj.getDate()
        const month = dateObj.toLocaleString('en-US', { month: 'short' }).toUpperCase()
        const year = (dateObj.getFullYear() % 100).toString().padStart(2, '0')
        return `${day} ${month} ${year}`
      }

      let allPaymentsData = {}
      let allTourBookingsData = {}
      let allTransferBookingsData = {}

      let selectedPaymentKeys = []
      let draftInvoiceDate = ''

      document.addEventListener('DOMContentLoaded', async () => {
        const selectPaymentsBtn = document.getElementById('selectPaymentsBtn')
        const confirmSelectBtn = document.getElementById('confirmSelectBtn')
        const printBtn = document.getElementById('printBtn')
        const saveInvoiceBtn = document.getElementById('saveInvoiceBtn')

        const invoiceTbody = document.querySelector('#invoiceTable tbody')
        const grandTotalDisplay = document.getElementById('grandTotalDisplay')

        const selectPaymentsModalEl = document.getElementById('selectPaymentsModal')
        const selectPaymentsModal = new bootstrap.Modal(selectPaymentsModalEl, {
          backdrop: 'static',
          keyboard: false,
        })
        const paymentsListContainer = document.getElementById('paymentsListContainer')

        if (printBtn) {
          printBtn.addEventListener('click', () => {
            window.print()
          })
        }

        const [paySnap, tourSnap, transferSnap] = await Promise.all([
          get(ref(database, 'payments')),
          get(ref(database, 'tourBookings')),
          get(ref(database, 'transferBookings')),
        ])

        if (paySnap.exists()) {
          allPaymentsData = paySnap.val()
        }
        if (tourSnap.exists()) {
          allTourBookingsData = tourSnap.val()
        }
        if (transferSnap.exists()) {
          allTransferBookingsData = transferSnap.val()
        }

        selectPaymentsBtn.addEventListener('click', () => {
          buildPaymentsList()
          selectPaymentsModal.show()
        })

        confirmSelectBtn.addEventListener('click', () => {
          selectedPaymentKeys = []
          const checkboxes = paymentsListContainer.querySelectorAll("input[type='checkbox']:checked")
          checkboxes.forEach(ck => {
            selectedPaymentKeys.push(ck.value)
          })
          selectPaymentsModal.hide()

          buildInvoiceTable(selectedPaymentKeys)

          if (selectedPaymentKeys.length > 0) {
            const invoiceDateSpan = document.getElementById('invoiceDateSpan')
            if (invoiceDateSpan) {
              invoiceDateSpan.textContent = draftInvoiceDate || 'กรุณากรอกวันที่'

              invoiceDateSpan.setAttribute('data-invoice-key', 'temp')
            }

            enableInvoiceDateEdit()
          }
        })

        function buildPaymentsList() {
          paymentsListContainer.innerHTML = ''
          let hasAny = false

          const mainKeys = Object.keys(allPaymentsData).sort()
          mainKeys.forEach(mainK => {
            const subObj = allPaymentsData[mainK]
            if (!subObj || typeof subObj !== 'object') return

            const subKeys = Object.keys(subObj).sort()
            subKeys.forEach(subK => {
              const payment = subObj[subK]

              if (payment.invoiced === true) {
                return
              }

              let displayName = ''

              if (payment.customer && payment.customer.firstName) {
                displayName = `${payment.customer.firstName}`
                if (payment.customer.lastName) {
                  displayName += ` ${payment.customer.lastName}`
                }
              } else {
              }

              hasAny = true
              const combinedKey = `${mainK}/${subK}`
              const alreadySelected = selectedPaymentKeys.includes(combinedKey)

              const label = document.createElement('label')
              label.classList.add('d-flex', 'align-items-center', 'mb-2')
              label.innerHTML = `
        <input
          type="checkbox"
          class="form-check-input me-2"
          value="${combinedKey}"
          ${alreadySelected ? 'checked' : ''}
        />
        <span>${displayName}</span>
      `
              paymentsListContainer.appendChild(label)
            })
          })

          if (!hasAny) {
            paymentsListContainer.innerHTML = `
      <div class="alert alert-warning">No Payments Found</div>
    `
          }
        }

        const refMap = {}

        function buildInvoiceTable(paymentKeys) {
          const invoiceTable = document.getElementById('invoiceTable')
          if (!invoiceTable) return

          const showCostProfit = document.getElementById('showCostProfitCheckbox')
            ? document.getElementById('showCostProfitCheckbox').checked
            : false

          const invoiceThead = invoiceTable.querySelector('thead')
          const invoiceTbody = invoiceTable.querySelector('tbody')
          if (!invoiceThead || !invoiceTbody) return

          let theadHtml = `
    <tr>
      <th>Item</th>
      <th>NAME</th>
      <th>REF.</th>
      <th>Hotel</th>
      <th>Date in PHUKET</th>
      <th>TOUR INCLUDE</th>
      ${showCostProfit ? `<th>Cost</th><th>PRICE</th><th>Profit</th>` : `<th>PRICE</th>`}
      <th>Fee</th>
      <th>Unit</th>
      <th>TOTAL</th>
    </tr>
  `
          invoiceThead.innerHTML = theadHtml

          invoiceTbody.innerHTML = ''

          const summaryContainer = document.getElementById('summaryCostProfitContainer')
          if (summaryContainer) {
            summaryContainer.style.display = showCostProfit ? 'block' : 'none'
          }

          if (!paymentKeys || paymentKeys.length === 0) {
            invoiceTbody.innerHTML = `
      <tr>
        <td colspan="${showCostProfit ? 12 : 10}" class="text-center text-danger">
          No Payments Selected
        </td>
      </tr>
    `

            return
          }

          let itemCount = 0
          let grandTotal = 0

          let totalCostSum = 0
          let totalSellingSum = 0
          let totalProfitSum = 0

          const refMap = {}

          paymentKeys.forEach(combinedKey => {
            const [mainK, subK] = combinedKey.split('/')
            if (!allPaymentsData[mainK] || !allPaymentsData[mainK][subK]) return

            const payment = allPaymentsData[mainK][subK]

            itemCount++

            let bookingsArr = []
            if (Array.isArray(payment.bookings)) {
              bookingsArr = payment.bookings
            } else if (payment.bookings && typeof payment.bookings === 'object') {
              bookingsArr = Object.values(payment.bookings)
            }

            if (!bookingsArr || bookingsArr.length === 0) {
              const tr = document.createElement('tr')
              tr.innerHTML = `
        <td>${itemCount}</td>
        <td>NAME ???</td>
        <td>REF ???</td>
        <td colspan="${showCostProfit ? 9 : 7}" class="text-danger">
          No bookings found
        </td>
      `
              invoiceTbody.appendChild(tr)
              return
            }

            let firstName = payment.customer?.firstName || ''
            let lastName = payment.customer?.lastName || ''
            let pax = payment.customer?.pax || ''
            const nameText = `${firstName} ${lastName} / ${pax}`.trim()

            const refKey = combinedKey
            refMap[refKey] = payment.ref || '-'

            let hotelText = '-'
            const firstBk = bookingsArr[0]
            if (firstBk) {
              if (firstBk.type === 'tour' && firstBk.tourHotel) {
                hotelText = firstBk.tourHotel
              } else if (firstBk.type === 'transfer' && firstBk.transferHotel) {
                hotelText = firstBk.transferHotel
              }
            }

            const paymentTotal = payment.summary?.totalSellingPrice || 0
            grandTotal += paymentTotal

            bookingsArr.sort((a, b) => {
              const dateA = a.tourDate || a.transferDate
              const dateB = b.tourDate || b.transferDate
              if (!dateA) return 1
              if (!dateB) return -1
              return new Date(dateA) - new Date(dateB)
            })

            const rowSpanCount = bookingsArr.length

            let orderCostSum = 0
            let orderPriceSum = 0
            let orderProfitSum = 0

            bookingsArr.forEach((bk, index) => {
              const unitVal = bk.quantity ?? 0
              const priceVal = bk.sellingPrice
              const costVal = bk.totalCostin ?? 0
              const rowTotal = priceVal * unitVal
              const profitVal = rowTotal - costVal
              const feeVal = bk.fee ?? 0

              const detailText = bk.detail || '-'
              const typeText = bk.type || bk.bookingType || '-'
              const bookingDate = bk.tourDate || bk.transferDate || '-'

              orderCostSum += costVal
              orderPriceSum += rowTotal
              orderProfitSum += profitVal

              totalCostSum += costVal
              totalSellingSum += rowTotal
              totalProfitSum += profitVal

              const tr = document.createElement('tr')

              if (index === 0) {
                tr.innerHTML = `
          <td rowspan="${rowSpanCount}">${itemCount}</td>
          <td rowspan="${rowSpanCount}" class="nameCell">${nameText}</td>
          <td rowspan="${rowSpanCount}" class="refCell" data-key="${refKey}">
            ${refMap[refKey]}
          </td>
          <td rowspan="${rowSpanCount}" class="hotelCell">${hotelText}</td>

          <td>${formatDate(bookingDate)}</td>
          <td class="text-start">${detailText} </td>

          ${
            showCostProfit
              ? `
                  <td>${formatNumberWithCommas(costVal)}</td>
                  <td>${formatNumberWithCommas(priceVal)}</td>
                  <td>${formatNumberWithCommas(profitVal)}</td>
                `
              : `
                  <td>${formatNumberWithCommas(priceVal)}</td>
                `
          }

          <td
            class="feeCell"
            data-maink="${mainK}"
            data-subk="${subK}"
            data-bk-index="${index}"
          >
            ${formatNumberWithCommas(feeVal)}
          </td>

          <td>${unitVal}</td>
          <td>${formatNumberWithCommas(rowTotal)}</td>
        `
              } else {
                tr.innerHTML = `
          <td>${formatDate(bookingDate)}</td>
          <td class="text-start">${detailText} </td>

          ${
            showCostProfit
              ? `
                  <td>${formatNumberWithCommas(costVal)}</td>
                  <td>${formatNumberWithCommas(priceVal)}</td>
                  <td>${formatNumberWithCommas(profitVal)}</td>
                `
              : `
                  <td>${formatNumberWithCommas(priceVal)}</td>
                `
          }

          <td
            class="feeCell"
            data-maink="${mainK}"
            data-subk="${subK}"
            data-bk-index="${index}"
          >
            ${formatNumberWithCommas(feeVal)}
          </td>

          <td>${unitVal}</td>
          <td>${formatNumberWithCommas(rowTotal)}</td>
        `
              }

              invoiceTbody.appendChild(tr)
            })
            if (showCostProfit) {
              const cpRow = document.createElement('tr')
              cpRow.innerHTML = `
    <td colspan="6" class="text-end fw-bold text-secondary">
      Sub-Total (Cost/Price/Profit)
    </td>
    <td class="fw-bold text-info">
      ${formatNumberWithCommas(orderCostSum)}
    </td>
    <td class="fw-bold text-primary">
      ${formatNumberWithCommas(orderPriceSum)}
    </td>
    <td class="fw-bold text-success">
      ${formatNumberWithCommas(orderProfitSum)}
    </td>
    <td colspan="2"></td>
  `
              invoiceTbody.appendChild(cpRow)
            }

            const totalRow = document.createElement('tr')
            totalRow.innerHTML = `
      <td colspan="${showCostProfit ? 10 : 8}" class="text-end fw-bold">
        Total
      </td>
      <td class="fw-bold" colspan="2">
        ${formatNumberWithCommas(paymentTotal)}
      </td>
    `
            invoiceTbody.appendChild(totalRow)
          })

          const grandRow = document.createElement('tr')
          grandRow.innerHTML = `
    <td colspan="${showCostProfit ? 10 : 8}" class="text-end fw-bold text-success">
      GRAND TOTAL
    </td>
    <td class="fw-bold text-success" colspan="2">
      ${formatNumberWithCommas(grandTotal)}
    </td>
  `
          invoiceTbody.appendChild(grandRow)

          if (showCostProfit) {
            if (summaryContainer) {
              const totalCostEl = document.getElementById('totalCost')
              const totalSellingEl = document.getElementById('totalSellingPrice')
              const totalProfitEl = document.getElementById('totalProfit')

              if (totalCostEl) totalCostEl.textContent = formatNumberWithCommas(totalCostSum)
              if (totalSellingEl) totalSellingEl.textContent = formatNumberWithCommas(totalSellingSum)
              if (totalProfitEl) totalProfitEl.textContent = formatNumberWithCommas(totalProfitSum)
            }
          }

          enableRefEdit?.()

          enableFeeEdit?.()
        }

        const viewSelectedInvoiceBtn = document.getElementById('viewSelectedInvoiceBtn')
        if (viewSelectedInvoiceBtn) {
          viewSelectedInvoiceBtn.addEventListener('click', async () => {
            const invoicesSelect = document.getElementById('invoicesSelect')
            if (!invoicesSelect.value) {
              alert('กรุณาเลือก Invoice ก่อน')
              return
            }
            const invoiceKey = invoicesSelect.value

            const invoiceSnap = await get(ref(database, 'invoices/' + invoiceKey))
            if (!invoiceSnap.exists()) {
              alert('ไม่พบข้อมูล Invoice นี้')
              return
            }
            const invoiceObj = invoiceSnap.val()

            if (!invoiceObj.selectedPaymentKeys || !Array.isArray(invoiceObj.selectedPaymentKeys)) {
              alert('Invoice นี้ไม่มี selectedPaymentKeys')
              return
            }

            console.log('Load Invoice:', invoiceKey, invoiceObj)
            document.getElementById('showCostProfitCheckbox').checked = true
            selectedPaymentKeys = invoiceObj.selectedPaymentKeys || []

            buildInvoiceTable(invoiceObj.selectedPaymentKeys)

            const invoiceDateSpan = document.getElementById('invoiceDateSpan')
            if (invoiceDateSpan) {
              if (invoiceObj.invoiceDate) {
                invoiceDateSpan.textContent = invoiceObj.invoiceDate
              } else {
                invoiceDateSpan.textContent = 'กรุณากรอกวันที่'
              }

              invoiceDateSpan.setAttribute('data-invoice-key', invoiceKey)
            }

            enableInvoiceDateEdit?.()

            const viewInvoiceModalEl = document.getElementById('viewInvoiceModal')
            const viewInvoiceModal = bootstrap.Modal.getInstance(viewInvoiceModalEl)
            viewInvoiceModal.hide()

            if (exportCsvBtn) exportCsvBtn.disabled = false
          })
        }
        async function storeRefInDB(mainKey, subKey, newVal) {
          const refPath = ref(database, `payments/${mainKey}/${subKey}/ref`)
          await set(refPath, newVal)
        }

        function enableRefEdit() {
          const refCells = invoiceTbody.querySelectorAll('.refCell')
          refCells.forEach(cell => {
            cell.addEventListener('dblclick', () => {
              const oldText = cell.textContent.trim()
              const combinedKey = cell.dataset.key
              if (!combinedKey) return

              const input = document.createElement('input')
              input.type = 'text'
              input.value = oldText === '-' ? '' : oldText
              input.classList.add('form-control')
              input.style.maxWidth = '120px'

              cell.textContent = ''
              cell.appendChild(input)
              input.focus()

              const saveRef = async () => {
                const newVal = input.value.trim() || '-'
                cell.innerHTML = newVal

                const [mainK, subK] = combinedKey.split('/')
                try {
                  await storeRefInDB(mainK, subK, newVal)
                } catch (err) {
                  console.error(err)
                  alert('ไม่สามารถบันทึก REF ได้')
                }
              }

              input.addEventListener('blur', saveRef)
              input.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                  e.preventDefault()
                  saveRef()
                }
              })
            })
          })
        }

        if (saveInvoiceBtn) {
          saveInvoiceBtn.addEventListener('click', async () => {
            const invoiceName = prompt('กรุณาตั้งชื่อ Invoice:', 'MyInvoice')
            if (!invoiceName) {
              alert('คุณยังไม่ได้ตั้งชื่อ Invoice')
              return
            }

            const invoicesRef = ref(database, 'invoices')
            const newInvoiceRef = push(invoicesRef)

            const invoicePayload = {
              invoiceName: invoiceName,
              createdAt: new Date().toISOString(),
              selectedPaymentKeys,
              invoiceDate: draftInvoiceDate || 'กรุณากรอกวันที่',
            }

            try {
              await set(newInvoiceRef, invoicePayload)

              for (let ck of selectedPaymentKeys) {
                const [mk, sk] = ck.split('/')
                const paymentRef = ref(database, `payments/${mk}/${sk}/invoiced`)
                await set(paymentRef, true)
              }

              alert(`บันทึก Invoice เรียบร้อย! InvoiceName: ${invoiceName}`)
            } catch (err) {
              console.error(err)
              alert('เกิดข้อผิดพลาดในการบันทึก Invoice')
            }
          })
        }
        document.getElementById('showCostProfitCheckbox')?.addEventListener('change', () => {
          if (selectedPaymentKeys && selectedPaymentKeys.length > 0) {
            buildInvoiceTable(selectedPaymentKeys)
          }
        })

        function setupRefEdit() {
          const refCells = invoiceTbody.querySelectorAll('.refCell')
          refCells.forEach(cell => {
            cell.addEventListener('dblclick', () => {
              const currentRef = cell.getAttribute('data-ref') || '-'

              const inputEl = document.createElement('input')
              inputEl.type = 'text'
              inputEl.value = currentRef
              inputEl.classList.add('ref-edit-input')

              cell.innerHTML = ''
              cell.appendChild(inputEl)
              inputEl.focus()

              const finalize = () => {
                const newVal = inputEl.value.trim() || '-'
                cell.setAttribute('data-ref', newVal)
                cell.textContent = newVal
              }
              inputEl.addEventListener('blur', finalize)
              inputEl.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                  finalize()
                }
              })
            })
          })
        }
        async function storeFeeInDB(mainKey, subKey, bookingIndex, feeValue) {
          const feeRef = ref(database, `payments/${mainKey}/${subKey}/bookings/${bookingIndex}/fee`)

          const numericFee = parseFloat(feeValue) || 0
          await set(feeRef, numericFee)
        }

        function enableFeeEdit() {
          const invoiceTbody = document.querySelector('#invoiceTable tbody')
          if (!invoiceTbody) return

          const feeCells = invoiceTbody.querySelectorAll('.feeCell')
          feeCells.forEach(cell => {
            cell.addEventListener('dblclick', () => {
              const oldText = cell.textContent.replace(/,/g, '').trim()
              const mainK = cell.getAttribute('data-maink')
              const subK = cell.getAttribute('data-subk')
              const bkIndex = cell.getAttribute('data-bk-index')

              const inputEl = document.createElement('input')
              inputEl.type = 'text'
              inputEl.value = oldText === '-' ? '' : oldText
              inputEl.classList.add('form-control')
              inputEl.style.maxWidth = '100px'

              cell.textContent = ''
              cell.appendChild(inputEl)
              inputEl.focus()

              const saveFee = async () => {
                const newVal = inputEl.value.trim()
                cell.innerHTML = newVal

                try {
                  const feeRef = ref(database, `payments/${mainK}/${subK}/bookings/${bkIndex}/fee`)
                  await set(feeRef, newVal)
                } catch (err) {
                  console.error('Error saving fee:', err)
                  alert('ไม่สามารถบันทึก Fee ได้')
                }
              }

              inputEl.addEventListener('blur', saveFee)
              inputEl.addEventListener('keydown', e => {
                if (e.key === 'Enter') {
                  e.preventDefault()
                  saveFee()
                }
              })
            })
          })
        }
        function enableInvoiceDateEdit() {
          const dateSpan = document.getElementById('invoiceDateSpan')
          if (!dateSpan) return

          dateSpan.addEventListener('dblclick', () => {
            const oldText = dateSpan.textContent.trim()
            const invoiceKey = dateSpan.getAttribute('data-invoice-key') || ''

            const inputEl = document.createElement('input')
            inputEl.type = 'text'
            inputEl.value = oldText === 'กรุณากรอกวันที่' ? '' : oldText
            inputEl.classList.add('form-control')
            inputEl.style.display = 'inline-block'
            inputEl.style.width = 'auto'

            dateSpan.innerHTML = ''
            dateSpan.appendChild(inputEl)
            inputEl.focus()

            const saveDate = async () => {
              const newVal = inputEl.value.trim() || 'กรุณากรอกวันที่'
              dateSpan.textContent = newVal

              if (invoiceKey === 'temp') {
                draftInvoiceDate = newVal
              } else {
                const dateRef = ref(database, `invoices/${invoiceKey}/invoiceDate`)
                await set(dateRef, newVal)
              }
            }

            inputEl.addEventListener('blur', saveDate)
            inputEl.addEventListener('keydown', e => {
              if (e.key === 'Enter') {
                e.preventDefault()
                saveDate()
              }
            })
          })
        }

        const addPaymentBtn = document.getElementById('addPaymentBtn')
        if (addPaymentBtn) {
          addPaymentBtn.addEventListener('click', () => {
            setupAddPaymentModal()
            openAddPaymentModal()
          })
        }
        const saveEditInvoiceBtn = document.getElementById('saveEditInvoiceBtn')
        if (saveEditInvoiceBtn) {
          saveEditInvoiceBtn.addEventListener('click', () => {
            saveEditInvoice()
          })
        }
        document.getElementById('editInvoiceBtn').addEventListener('click', () => {
          openEditInvoiceModal()
        })
      })
      let editInvoiceModal
      let currentEditingInvoiceKey = ''
      let currentEditingPayments = []

      function openEditInvoiceModal() {
        if (!editInvoiceModal) {
          const modalEl = document.getElementById('editInvoiceModal')
          editInvoiceModal = new bootstrap.Modal(modalEl, { backdrop: 'static' })
        }
        currentEditingInvoiceKey = ''
        currentEditingPayments = []
        buildInvoiceListForEdit()
        document.getElementById('invoiceSearchInput').value = ''
        document.getElementById('invoicesDataList').innerHTML = ''
        document.getElementById('selectedPaymentsList').innerHTML = ''
        editInvoiceModal.show()
      }

      async function buildInvoiceListForEdit() {
        const invoiceSearchInput = document.getElementById('invoiceSearchInput')
        const invoicesDataList = document.getElementById('invoicesDataList')
        if (!invoiceSearchInput || !invoicesDataList) return

        const invoicesSnap = await get(ref(database, 'invoices'))
        if (!invoicesSnap.exists()) return

        const data = invoicesSnap.val()
        const keys = Object.keys(data)
        invoicesDataList.innerHTML = ''

        keys.forEach(k => {
          let n = data[k].invoiceName || '(No Name)'
          let opt = document.createElement('option')
          opt.value = n
          opt.dataset.key = k
          invoicesDataList.appendChild(opt)
        })

        invoiceSearchInput.addEventListener(
          'change',
          () => {
            let val = invoiceSearchInput.value.trim()
            if (!val) return

            let selectedOption = Array.from(invoicesDataList.children).find(opt => opt.value === val)
            if (!selectedOption) return

            let invoiceKey = selectedOption.dataset.key
            loadInvoiceForEdit(invoiceKey)
          },
          { once: true }
        )
      }

      async function loadInvoiceForEdit(k) {
        const snap = await get(ref(database, 'invoices/' + k))
        if (!snap.exists()) return
        const invObj = snap.val()
        currentEditingInvoiceKey = k
        currentEditingPayments = []
        if (invObj.selectedPaymentKeys && Array.isArray(invObj.selectedPaymentKeys)) {
          currentEditingPayments = invObj.selectedPaymentKeys.slice()
        }
        buildSelectedPaymentsList()
      }

      function movePaymentUp(idx) {
        if (idx <= 0) return
        let tmp = currentEditingPayments[idx]
        currentEditingPayments[idx] = currentEditingPayments[idx - 1]
        currentEditingPayments[idx - 1] = tmp
        buildSelectedPaymentsList()
      }
      let addPaymentModal
      function setupAddPaymentModal() {
        if (!addPaymentModal) {
          const el = document.getElementById('addPaymentModal')
          addPaymentModal = new bootstrap.Modal(el, { backdrop: 'static' })
        }
      }
      function movePaymentDown(idx) {
        if (idx >= currentEditingPayments.length - 1) return
        let tmp = currentEditingPayments[idx]
        currentEditingPayments[idx] = currentEditingPayments[idx + 1]
        currentEditingPayments[idx + 1] = tmp
        buildSelectedPaymentsList()
      }

      function openAddPaymentModal() {
        buildAddPaymentList()
        addPaymentModal.show()
      }

      window.deletePaymentFromInvoice = deletePaymentFromInvoice
      window.movePaymentUp = movePaymentUp
      window.movePaymentDown = movePaymentDown
      window.addPaymentToInvoice = addPaymentToInvoice
      window.setupAddPaymentModal = setupAddPaymentModal
      window.openAddPaymentModal = openAddPaymentModal

      function buildSelectedPaymentsList() {
        const listEl = document.getElementById('selectedPaymentsList')
        if (!listEl) return
        listEl.innerHTML = ''
        currentEditingPayments.forEach((ck, idx) => {
          let li = document.createElement('li')
          li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center')
          let label = getDisplayNameFromPaymentKey(ck)
          li.innerHTML = `
      <div>
        <span class="me-2">${label}</span>
        <button class="btn btn-sm btn-link text-danger" data-idx="${idx}" onclick="deletePaymentFromInvoice(${idx})">Delete</button>
      </div>
      <div>
        <button class="btn btn-sm btn-secondary me-1" onclick="movePaymentUp(${idx})">Up</button>
        <button class="btn btn-sm btn-secondary" onclick="movePaymentDown(${idx})">Down</button>
      </div>
    `
          listEl.appendChild(li)
        })
      }

      function getDisplayNameFromPaymentKey(ck) {
        let splitted = ck.split('/')
        let mk = splitted[0]
        let sk = splitted[1]
        if (!allPaymentsData[mk] || !allPaymentsData[mk][sk]) return ck
        let p = allPaymentsData[mk][sk]
        if (p.customer && p.customer.firstName) {
          let f = p.customer.firstName
          let l = p.customer.lastName ? p.customer.lastName : ''
          return `${f} ${l}`.trim()
        }
        return ck
      }

      function deletePaymentFromInvoice(idx) {
        currentEditingPayments.splice(idx, 1)
        buildSelectedPaymentsList()
      }

      function buildAddPaymentList() {
        const addListEl = document.getElementById('addPaymentList')
        if (!addListEl) return
        addListEl.innerHTML = ''
        const mainKeys = Object.keys(allPaymentsData).sort()
        mainKeys.forEach(mk => {
          let subObj = allPaymentsData[mk]
          if (!subObj) return
          let subKeys = Object.keys(subObj).sort()
          subKeys.forEach(sk => {
            let pay = subObj[sk]
            if (pay.invoiced === true) return
            let label = ''
            if (pay.customer && pay.customer.firstName) {
              label = pay.customer.firstName
              if (pay.customer.lastName) label += ' ' + pay.customer.lastName
            }
            let ck = mk + '/' + sk
            let li = document.createElement('li')
            li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center')
            li.innerHTML = `
        <span>${label}</span>
        <button class="btn btn-sm btn-primary" onclick="addPaymentToInvoice('${ck}')">Add</button>
      `
            addListEl.appendChild(li)
          })
        })
      }

      function addPaymentToInvoice(ck) {
        if (!currentEditingPayments.includes(ck)) {
          currentEditingPayments.push(ck)
        }
        buildSelectedPaymentsList()
      }

      async function saveEditInvoice() {
        if (!currentEditingInvoiceKey) return
        let invKey = currentEditingInvoiceKey
        let invRef = ref(database, 'invoices/' + invKey)
        let snapshot = await get(invRef)
        if (!snapshot.exists()) return
        let obj = snapshot.val()
        obj.selectedPaymentKeys = currentEditingPayments.slice()
        await set(invRef, obj)
        editInvoiceModal.hide()
      }
      function formatDate(dateStr) {
        if (!dateStr || dateStr === '-') return '-'

        const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC']
        const [year, month, day] = dateStr.split('-')
        if (!year || !month || !day) return dateStr

        const shortYear = year.slice(2)
        const shortMonth = months[parseInt(month, 10) - 1]

        return `${day} ${shortMonth} ${shortYear}`
      }

      const exportCsvBtn = document.getElementById('exportCsvBtn')
      if (exportCsvBtn) {
        exportCsvBtn.disabled = true

        exportCsvBtn.addEventListener('click', () => {
          exportTableToCSV('invoice_export.csv')
        })
      }

      function exportTableToCSV(filename) {
        const table = document.getElementById('invoiceTable')
        if (!table) {
          alert('ไม่พบตาราง invoiceTable')
          return
        }
        let csv = []

        for (let i = 0; i < table.rows.length; i++) {
          let row = []
          for (let j = 0; j < table.rows[i].cells.length; j++) {
            let text = table.rows[i].cells[j].innerText.replace(/(\r\n|\n|\r)/gm, '')
            text = text.replace(/"/g, '""')
            row.push(`"${text}"`)
          }
          csv.push(row.join(','))
        }

        const csvString = csv.join('\n')

        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' })
        const link = document.createElement('a')
        const url = URL.createObjectURL(blob)
        link.setAttribute('href', url)
        link.setAttribute('download', filename)
        link.style.visibility = 'hidden'
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
      }
      const viewInvoiceBtn = document.getElementById('viewInvoiceBtn')
      if (viewInvoiceBtn) {
        viewInvoiceBtn.addEventListener('click', () => {
          viewInvoiceList()
        })
      }

      async function viewInvoiceList() {
        const invoicesSnap = await get(ref(database, 'invoices'))
        if (!invoicesSnap.exists()) {
          alert('ยังไม่มี Invoice ใดๆ')
          return
        }
        const invoicesData = invoicesSnap.val()

        const invoicesSelect = document.getElementById('invoicesSelect')
        if (!invoicesSelect) {
          alert('ไม่พบ select #invoicesSelect')
          return
        }
        invoicesSelect.innerHTML = ''

        const invoiceKeys = Object.keys(invoicesData)
        invoiceKeys.forEach(k => {
          const invObj = invoicesData[k]
          const option = document.createElement('option')
          option.value = k
          const invName = invObj.invoiceName || '(NoName)'

          option.textContent = `${invName}`
          invoicesSelect.appendChild(option)
        })

        const viewInvoiceModalEl = document.getElementById('viewInvoiceModal')
        if (!viewInvoiceModalEl) {
          alert('ไม่มี modal #viewInvoiceModal ใน HTML')
          return
        }
        const viewInvoiceModal = new bootstrap.Modal(viewInvoiceModalEl, {
          backdrop: 'static',
          keyboard: false,
        })
        viewInvoiceModal.show()
      }
    </script>
  </body>
</html>
