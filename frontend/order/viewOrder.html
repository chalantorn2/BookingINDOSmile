<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>View Orders</title>
    <!-- Google Font -->
    <link
      href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <!-- Bootstrap CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/order.css" />
  </head>

  <body>
    <menu-component></menu-component>

    <div class="container py-5">
      <div class="header text-center mb-4">
        <h1 class="title">View Orders</h1>
        <p class="subtitle">ตรวจสอบ Orders และ Booking ที่เกี่ยวข้อง</p>
      </div>

      <!-- Add and Dashboard Buttons -->
      <div class="d-flex justify-content-center mb-4">
        <a href="addOrder.html" class="btn btn-primary me-2">Add Order</a>
        <!-- <a href="dashboard.html" class="btn btn-secondary">Dashboard Order</a> -->
      </div>
      <div class="d-flex justify-content-center align-items-center mb-4">
        <input
          type="text"
          id="searchInput"
          class="form-control w-50"
          placeholder="Search by Order ID"
        />
        <select id="sortSelector" class="form-select w-25">
          <option value="earliestDate">Earliest Date</option>
          <option value="latestDate">Latest Date</option>
          <option value="orderID">Order ID</option>
        </select>
      </div>

      <!-- Orders List -->
      <div class="mt-4">
        <h2 class="text-center">Orders</h2>
        <ul class="list-group" id="ordersList">
          <li class="list-group-item text-center">Loading...</li>
        </ul>
      </div>
    </div>

    <script type="module" src="/component/menu.js"></script>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        get,
      } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-database.js";
      import { database } from "/js/firebase-config.js";

      document.addEventListener("DOMContentLoaded", async () => {
        const ordersList = document.getElementById("ordersList");

        ordersList.innerHTML =
          '<li class="list-group-item text-center">Loading...</li>';

        try {
          const ordersRef = ref(database, "orders");
          const ordersSnapshot = await get(ordersRef);

          if (!ordersSnapshot.exists()) {
            ordersList.innerHTML =
              '<li class="list-group-item text-center">No orders found</li>';
            return;
          }

          const orders = ordersSnapshot.val();

          ordersList.innerHTML = "";

          for (const orderId of Object.keys(orders)) {
            const order = orders[orderId];
            const bookings = order.bookings || [];

            let agent = "Unknown Agent";
            let customerName = "Unknown Name";
            let bookingDetails = [];

            const bookingPromises = bookings.map(async (bookingId) => {
              const tourRef = ref(database, `tourBookings/${bookingId}`);
              const transferRef = ref(
                database,
                `transferBookings/${bookingId}`
              );

              let bookingData = null;
              const tourSnap = await get(tourRef);

              if (tourSnap.exists()) {
                bookingData = tourSnap.val();
                agent = bookingData.tourAgent || agent;
                customerName = `${bookingData.tourFirstName || ""} ${
                  bookingData.tourLastName || ""
                }`.trim();

                bookingDetails.push({
                  date: bookingData.tourDate,
                  time: bookingData.tourPickUpTime || "00:00",
                  type: "Tour",
                  sendTo: bookingData.tourSendTo || "-",
                  id: bookingData.tourID || bookingId,
                });
              } else {
                const transferSnap = await get(transferRef);
                if (transferSnap.exists()) {
                  bookingData = transferSnap.val();
                  agent = bookingData.transferAgent || agent;
                  customerName = `${bookingData.transferFirstName || ""} ${
                    bookingData.transferLastName || ""
                  }`.trim();

                  bookingDetails.push({
                    date: bookingData.transferDate,
                    time: bookingData.transferPickUpTime || "00:00",
                    type: "Transfer",
                    sendTo: bookingData.transferSendTo || "-",
                    id: bookingData.transferID || bookingId,
                  });
                }
              }
            });

            await Promise.all(bookingPromises);

            // เรียงลำดับตามวันที่และเวลารับ
            bookingDetails.sort((a, b) => {
              const dateA = new Date(a.date);
              const dateB = new Date(b.date);
              if (dateA - dateB !== 0) return dateA - dateB;
              return a.time.localeCompare(b.time);
            });

            // คำนวณช่วงวันที่
            let earliestDate = null;
            let latestDate = null;

            bookingDetails.forEach((booking) => {
              const currentDate = new Date(booking.date);
              if (!earliestDate || currentDate < earliestDate) {
                earliestDate = currentDate;
              }
              if (!latestDate || currentDate > latestDate) {
                latestDate = currentDate;
              }
            });

            const formatDate = (date) => {
              if (!date) return "Unknown Date";
              const d = new Date(date);
              const day = String(d.getDate()).padStart(2, "0");
              const month = String(d.getMonth() + 1).padStart(2, "0");
              const year = d.getFullYear();
              return `${day}/${month}/${year}`;
            };

            const listItem = document.createElement("li");
            listItem.className = "list-group-item";

            listItem.innerHTML = `
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h6 class="mb-1"><strong>${order.id || "No ID"}</strong></h6>
        <p class="mb-0 text-muted">${customerName} | 
        <span class="badge bg-secondary">${formatDate(
          earliestDate
        )} - ${formatDate(latestDate)}</span></p>
      </div>
      <button class="btn btn-outline-primary btn-sm toggle-details" data-order-id="${orderId}">
        <i class="bi bi-caret-down"></i> Details
      </button>
    </div>
    
  </div>
  <ul class="list-group mt-3 d-none" id="details-${orderId}"></ul>
</div>
`;

            ordersList.appendChild(listItem);

            const toggleButton = listItem.querySelector(".toggle-details");
            const detailsList = listItem.querySelector(`#details-${orderId}`);

            toggleButton.addEventListener("click", () => {
              if (detailsList.classList.contains("d-none")) {
                if (detailsList.innerHTML === "") {
                  if (bookingDetails.length === 0) {
                    detailsList.innerHTML =
                      '<li class="list-group-item">No bookings</li>';
                  } else {
                    bookingDetails.forEach((booking, index) => {
                      const bookingItem = document.createElement("li");
                      bookingItem.className =
                        "list-group-item d-flex justify-content-between align-items-center";
                      bookingItem.innerHTML = `
<div>
  <strong>${index + 1}. ${booking.type}</strong>
  <small>
    <span class="text-muted">Date:</span> ${formatDate(booking.date)} |
    <span class="text-muted">Time:</span> ${booking.time} |
    <span class="text-muted">Send To:</span> ${booking.sendTo}
  </small>
</div>
<span class="badge bg-primary">${booking.id}</span>
`;
                      detailsList.appendChild(bookingItem);
                    });
                  }
                }
                detailsList.classList.remove("d-none");
                toggleButton.innerHTML = '<i class="bi bi-caret-up"></i>';
              } else {
                detailsList.classList.add("d-none");
                toggleButton.innerHTML = '<i class="bi bi-caret-down"></i>';
              }
            });
          }
        } catch (error) {
          console.error("Error fetching orders:", error);
          ordersList.innerHTML =
            '<li class="list-group-item text-center text-danger">Failed to load orders</li>';
        }
      });

      function formatToDDMMYYYY(dateString) {
        if (!dateString || dateString === "-") return "-";
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }

      let ordersData = []; // เก็บข้อมูลทั้งหมด

      function renderOrders(filteredOrders) {
        ordersList.innerHTML = "";
        filteredOrders.forEach((order) => {
          const listItem = document.createElement("li");
          listItem.className = "list-group-item";
          listItem.innerHTML = `
<div class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h6 class="mb-1"><strong>${order.id || "No ID"}</strong></h6>
        <p class="mb-0 text-muted">${order.customerName || "Unknown Name"} | 
        <span class="badge bg-secondary">${formatDate(
          order.earliestDate
        )} - ${formatDate(order.latestDate)}</span></p>
      </div>
    </div>
  </div>
</div>`;
          ordersList.appendChild(listItem);
        });
      }
    </script>
  </body>
</html>
